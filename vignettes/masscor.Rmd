---
title: "masscor package"
author: "Cristhian Paredes"
date: "`r Sys.Date()`"
output: 
  knitr:::html_vignette:
    toc: true
    fig_caption: yes
  pdf_document:
    highlight: null
    number_sections: yes
vignette: >
  %\VignetteIndexEntry{masscor}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: bibliography.bib  
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
# Render html vignetes by using devtools::document(roclets = "vignette")
# Render also pdf vignetes by using rmarkdown::render("vignettes/labsimplex.Rmd", "all")
```

The R package `masscor` provides functions, classes and methods to support mass measurements using digital balances. The provided classes can store the calibration information for balances and mass standards, to later allow the conversion of balance readings to both conventional mass and real mass, and to perform routine balance verification by using the normalized error function. Air buoyancy correction factors are calculated using local air density that can be calculated using measured environmental conditions and applying one of several models available in the package. The uncertainty of (corrected) mass measurements can also be calculated allowing to improve mass measurements processes in the laboratory.

This package contains example data sets with real and hypothetical calibration data for some balances, a single mass standard and a mass standards kit, to illustrate the use of the functions inside the package. This vignette is intended as a user manual for the `masscor` package.

## Installation and use

The last released version of the package `masscor` can be installed from CRAN by running:

```{r,  eval = FALSE}
install.packages("masscor")
```

The development version of masscor can be installed from [GitHub](https://github.com/Crparedes/masscor "masscor GitHub Repository") using `install_github()` function from `devtools` package [@devtools]:

```{r,  eval = FALSE}
devtools::install_github("Crparedes/masscor", build_vignettes = TRUE)
```

To use the functions in `masscor`, the package must be loaded into R environment after the installation by running:

```{r setup}
library(masscor)
```

## Balance calibration certificates using the `masscor` package

The calibration of a balance involve the comparison between balance readings and the previously established masses of mass standards that are traceable to the International System of Units. The calibration certificate of a balance will at least include a table containing indication errors and associated uncertainties for several mass readings in the measurement interval of the balance, and information of the balance division scale (readability). This indication errors can later be used to correct a given balance reading to a conventional mass value with metrological traceability (see `convMass()`). The uncertainties of the indication errors provide information to estimate the uncertainty in the conventional mass due to this correction. Generally, additional uncertainty sources must be considered.

The package `masscor` uses objects of class `calibCert` to store the information of balance calibration certificates. This class of objects are generated by the function `calibCert()`. Mandatory arguments for the function are the nominal mass, indication error and associated uncertainty for at least two mass standards used in the balance calibration and the balance division scale. It is recommended to specify the units for each parameter as long as they are likely to have different units among them and vary for each balance type. Default values are grams for the nominal masses and milligrams for the other parameters.

Suppose an hypothetical analytic balance (scale division of 0.1\ mg) has been calibrated using only two (traceable) mass standards of nominal masses 5 and 20\ g. Suppose the indication errors are -0.2 and -0.1\ mg, respectively. The uncertainty of those indication errors will include the uncertainty of the masses for each mass standard. The indication error uncertainties are 0.200 and 0.205\ mg for the balance readings at 5 and 20\ g, respectively. This information is enough to produce an object of class `calibCert` that can later be used to correct a balance reading in the interval between 5 and 20\ g. A balance identification string can be provided indicating, for example brand, type and location of the balance.

```{r calibCert1}
Balance.1_Lab.317 <- calibCert(balanceID = '(Brand) Analytic balance lab 317', 
                               massSTD = c(5, 20),        # grams 
                               indError = c(-0.2, -0.1),  # miligrams
                               uncert = c(0.200, 0.201),  # miligrams 
                               d = 0.1,                   # miligrams
                               units = c('g', 'mg', 'mg', 'mg'))
```

The package provides methods to `print` and `plot` the information contained in objects of class `calibCert`:
```{r calibCert2}
print(Balance.1_Lab.317)
plot(Balance.1_Lab.317)
```

The objects of class `calibCert` must be created when the balance undergoes its first calibration and must be updated each time the balance undergoes recalibration. The best way to share the `calibCert` objects among the people that uses the balance is by saving the `calibCert` object as a `.RData` file using the function `save()`. When required, the `calibCert` object can be loaded into the R Environment by using the function `load()`.

```{r calibCert3}
save(Balance.1_Lab.317, file = 'certificateBalance.1_Lab.317.RData')
load(file = 'certificateBalance.1_Lab.317.RData')
```

Additional information of the calibration certificate can be set in the optional parameters of the function `calibCert()` (run `help(calibCert)` for details). Some balance calibration certificates provided as example data sets in the package illustrate the purpose of those optional parameters.
```{r calibCert4}
data(MT.XPE.204)
print(MT.XPE.204)
plot(MT.XPE.204)
```

# Conventional mass correction using calibration information

We live and realize mass measurements in air. The air causes the objects to float and this buoyancy affects the measurement of its mass. The real mass of an object (or simply, its mass) would be that determined in complete vacuum or that corrected by the air buoyancy effect. Mass air buoyancy corrections are easy to apply if both the densities of the object whose mass is being measured and that of the air causing it to float are known or properly estimated (see section air buoyancy correction). As long as this correction is usually very small and the complete information is not always known, a common practice is to report the mass of objects under arbitrarily agreed conditions, leading to the conventional mass of the object.

The conventional mass of an object is defined as the mass $m_c$ of a mass standard that balances this body under conventionally chosen conditions: at a temperature $t_{ref} = 20^o\text{C}$, with mass standards of density $\rho_c=8000~\text{kg m}^{-3}$, in normal air of density $\rho_0=1.2~\text{kg m}^{-3}$ [@OIML_D28_2004].

The balance calibration information is used to convert a balance reading to conventional mass. The indication error reported in the certificate has the same magnitude of the correction that is needed but with opposite sign. The particular mass correction that must be applied to a given balance reading is obtained by interpolating the value into the straight line defined by the two closest calibration points. This technique known as bracketing corrects the balance reading and provides an uncertainty value  for the conventional mass obtained, due to the balance calibration.

The `masscor` package uses the calibration information contained in an object of class `calibCert` to 

### Conventional mass uncertainty

## Air buoyancy correction

### Air density models and associated uncertainty

### Uncertainty of air bouyancy correction

## Additional functions in the package

### Data for mass standards and mass standards kits

### Routine balance verification: normalized error
