---
title: "masscor package"
author: "Cristhian Paredes"
date: "`r Sys.Date()`"
output: 
  knitr:::html_vignette:
    toc: true
    fig_caption: yes
  pdf_document:
    highlight: null
    number_sections: yes
vignette: >
  %\VignetteIndexEntry{masscor}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: bibliography.bib  
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
# Render html vignetes by using devtools::document(roclets = "vignette")
# Render also pdf vignetes by using rmarkdown::render("vignettes/labsimplex.Rmd", "all")
```

The R package `masscor` provides functions, classes and methods to support mass measurements using (mainly) digital balances. The new classes are objects that can store the calibration information for balances and mass standards, to later allow the conversion from balance readings to both conventional mass and real mass, and to perform routine balance verification (by using the normalized error function). Air buoyancy correction factors are calculated using local air density that can be calculated using measured environmental conditions and applying one of several models available in the package. The uncertainty of (corrected) mass measurements can also be calculated allowing to further asses the suitability of a given mass measurement.

This package contains example data sets with real and hypothetical calibration data for some balances, a single mass standard and a mass standards kit, to illustrate the use of the functions inside the package. This vignette is intended as a user manual for the `masscor` package.

## Installation and use

The last released version of the package `masscor` can be installed from CRAN by running:

```{r,  eval = FALSE}
install.packages("masscor")
```

The development version of masscor can be installed from [GitHub](https://github.com/Crparedes/masscor "masscor GitHub Repository") using `install_github()` function from `devtools` package [@devtools]:

```{r,  eval = FALSE}
devtools::install_github("Crparedes/masscor", build_vignettes = TRUE)
```

To use the functions in `masscor`, the package must be loaded into R environment after the installation by running:

```{r setup}
library(masscor)
```

## Balance calibration certificates using the `masscor` package

The calibration of a balance involve the comparison between balance readings and the previously established masses of mass standards that are traceable to the International System of Units. The calibration certificate of a balance will at least include a table containing indication errors and associated uncertainties for several mass readings in the measurement interval of the balance, and information about the balance division scale (readability) which is usually also indicated somewhere in the body of the balance. The indication errors can later be used to correct a given balance reading to a conventional mass value with metrological traceability (see `convMass()`). The uncertainties of the indication errors provide information to estimate the uncertainty in the conventional mass due to this correction. Generally, additional uncertainty sources due to balance readability and repeatability must be considered.

The package `masscor` uses objects of class `calibCert` to store the information of balance calibration certificates. This class of objects are generated by the function `calibCert()`. Mandatory arguments for the function are the nominal mass, indication error and associated uncertainty for at least two mass standards used in the balance calibration and the balance division scale. It is recommended to specify the units for each parameter as long as they are likely to differ among them and vary for each balance type. Default values are grams for the nominal masses and milligrams for all the other parameters.

Suppose the simplest case in which an analytic balance (scale division of 0.1\ mg) has been calibrated using only two (traceable) mass standards of nominal masses 5 and 20\ g. The indication errors are -0.2$\pm$0.200 and -0.1$\pm$0.205\ mg, respectively. The stated standard uncertainties include the uncertainty of the assigned mass for each mass standard. This information is enough to produce an object of class `calibCert` that can later be used to correct a balance reading in the interval between 5 and 20\ g. A balance identification string can be provided indicating, for example brand, type and location of the balance.

```{r calibCert1}
Balance.1_Lab.317 <- calibCert(balanceID = '(Brand) Analytic balance lab 317', 
                               massSTD = c(5, 20),        # grams 
                               indError = c(-0.2, -0.1),  # miligrams
                               uncert = c(0.200, 0.201),  # miligrams 
                               d = 0.1,                   # miligrams
                               units = c('g', 'mg', 'mg', 'mg'))
```

The package provides methods to `print` and `plot` the information contained in objects of class `calibCert`:
```{r calibCert2}
print(Balance.1_Lab.317)
plot(Balance.1_Lab.317)
```

The objects of class `calibCert` must be created when the balance undergoes its first calibration and must be updated each time the balance undergoes recalibration. The best way to share the `calibCert` objects among the people that uses the balance is by saving the `calibCert` object as a `.RData` file using the R function `save()`. When required, the `calibCert` object can be loaded into the R Environment by using the function `load()`. 

```{r calibCert3}
save(Balance.1_Lab.317, file = 'certificateBalance.1_Lab.317.RData')
load(file = 'certificateBalance.1_Lab.317.RData')
```
The directory to/from which the `.RData` file is going to be saved/loaded must be kept in mind. See `help(getwd)` for further details.

Additional information of the calibration certificate can be set in the optional parameters of the function `calibCert()` (run `help(calibCert)` for details). Some balance calibration certificates provided as example data sets in the package illustrate the purpose of those optional parameters.
```{r calibCert4}
data(MT.XPE.204)
print(MT.XPE.204)
plot(MT.XPE.204)
```

## Conventional mass corrections

We live and realize mass measurements in air. The air causes the objects to float and this buoyancy affects the measurement of their masses. The real mass of an object (or simply, its mass) would be that determined in complete vacuum or that corrected by the air buoyancy effect. Mass air buoyancy corrections are easy to apply if both the densities of the object whose mass is being measured and that of the air causing it to float are known or properly estimated (see Section Mass Air Buoyancy Correction). As long as this correction is usually very small and the complete information to perform it is not always known, a common practice is to report the mass of objects under arbitrarily agreed conditions, leading to the conventional mass of the object.

The conventional mass of an object is defined as the mass $m_c$ of a mass standard that balances this body under conventionally chosen conditions: at a temperature $t_{ref} = 20^o\text{C}$, with mass standards of density $\rho_c=8000~\text{kg m}^{-3}$, in normal air of density $\rho_0=1.2~\text{kg m}^{-3}$ [@OIML_D28_2004].

The balance calibration information is used to convert a balance reading to conventional mass. The indication error reported for each mass standard in the balance calibration certificate is the opposite of the correction needed for the given balance at that load. The mass correction that must be applied to a given balance reading is obtained by interpolating the value into the straight line defined by the two closest calibration points. This technique known as bracketing corrects the balance reading and provides an uncertainty estimate for the conventional mass obtained due to the correction.

The `masscor` package uses the calibration information contained in an object of class `calibCert` to obtain a conventional mass correction by using the function `convMass()`.

Suppose we use the balance whose calibration certificate is stored in the example data set `MT.XPE.204` provided with the package. For a balance reading of 211.1342\ g, the (corrected) conventional mass is obtained by running:

```{r convMass1}
data(MT.XPE.204)
convMass(reading = 211.1342, units = 'g', calibCert = MT.XPE.204)
```

### Conventional mass uncertainty
The uncertainty in the conventional mass of an object includes both the uncertainty from the indication error correction and the uncertainty in the balance reading which in turn considers the uncertainty due to balance readability, related to the balance division scale and the uncertainty arising from the lack of repeatability.

Uncertainty from the indication error correction by bracketing corresponds to the combination of the uncertainties in the two indication errors used in the interpolation:$$u_{error}=\sqrt{u_{low}^2 + u_{high}^2}$$%
where $u_{low}$ is the uncertainty in the indication error correction for the lower point and $u_{high}$ is the uncertainty in the indication error correction for the higher point used in the interpolation.

Uncertainty in the balance reading combines the lack of repeatability obtained as the standard deviation from measures of the same object's mass, and the effect of the readability obtained from the balance division scale by assuming a triangular probability density function: $$u_{read}=\sqrt{sd^2+\frac{d^2}{6}}$$%
where $sd$ is the measurements standard deviation and $d$ is the balance division scale.

The balance reading and the indication error uncertainties are combined as usual:
$$u_{mass}=\sqrt{u_{error}^2 + u_{read}^2}$$

**preguntar si esto que sigue estÃ¡ bien** 
Mass measurements usually involve taring the balance to perform a mass measurement by substracting the zero. In these terms the uncertainty estimate should include these rest would be $$u_{mass}=\sqrt{u_{error}^2 + 2\cdot u_{read}^2}$$
**Confirmar esto anterior y modificar las funciones segun corresponda...**

The main function to asses the uncertainty in a conventional mass value using `masscor` package is `uncertMassConv()`. This function internally calls the functions `uncertErrorCorr()` and `uncertReading()` that calculate the uncertainties of the indication error correction and balance reading, respectively.

Following with the previous example, assuming the repeated measurements standard deviation is 0.03\ mg, the uncertainty in the conventional mass is:

```{r convMass2}
uncertConvMass(reading = 211.1342, units = 'g', repValues = 0.03e-3, 
               calibCert = MT.XPE.204, tare = TRUE)
``` 
In some cases the experimenter is willing to give up some readability in order to improve the time a mass measurement can take. In those events balances are used with a division scale bigger from the division scale stated in the calibration certificate. The uncertainty in the balance reading must consider the change in the balance division scale so the used division scale can be provided to the functions `uncertMassConv()` and `uncertReading()` as an optional parameter. 

If the measurement from the previous example is performed with a division scale of 1\ mg instead of the default of 0.1\ mg, the conventional mass uncertainty is:

```{r convMass3}
uncertConvMass(reading = 211.134, units = 'g', d = 1e-3, repValues = 0.03e-3, 
               calibCert = MT.XPE.204, tare = TRUE)
```
## Air buoyancy correction
As mentioned in previous section, when measuring the mass of an object in air the object experiences buoyancy and its mass is affected. This effect is usually very small and can be safely ignored most of the times. When the correction is needed, the mass conventional mass of the object being measured can be corrected by multiplying it by its mass air buoyancy correction (MABC) factor defined as $$MABC=\frac{1-\frac{    \rho_{air}}{\rho_{weights}}}{1-\frac{\rho_{air}}{\rho_{sample}}}$$%
where $\rho_{air}$ is the local air density (around 1.2\ $kg~m^{-3}$), $\rho_{weights}$ is the density of the mass standards used during calibration (most of the times the mass standards are made of stainless steel with a density of 8000\ $kg~m^{-3}$), and $\rho_{sample}$ is the density of the object.

The function `MABC()` calculates mass air buoyancy correction factors using the above formula. The densities must be provided all in same units.
```{r MABC1}
MABC(rho_s = 0.997, rho_w = 8, rho_air = 0.001199314) # g/mL
MABC(rho_s = 997, rho_w = 8000, rho_air = 1.199314) # g/mL
``` 
### Air density models and associated uncertainty

### Uncertainty of air bouyancy correction

## Additional functions in the package

### Data for mass standards and mass standards kits

### Routine balance verification: normalized error
